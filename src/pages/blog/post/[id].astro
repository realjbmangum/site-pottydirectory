---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import StructuredData from '../../../components/StructuredData.astro';
import AdSlot from '../../../components/AdSlot.astro';
import siteConfig from '../../../data/site-config.json';
import { getBlogById, getPublishedBlogs, type ContentQuestion } from '../../../lib/supabase';

export async function getStaticPaths() {
  const posts = await getPublishedBlogs('potty');
  return posts.map((post) => ({
    params: { id: post.id },
    props: { post }
  }));
}

const { id } = Astro.params;
const { post } = Astro.props as { post: ContentQuestion };

const siteUrl = `https://${siteConfig.domain}`;

// Format category for display
const categoryDisplay = post.category?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'General';

// Calculate read time
const wordCount = post.answer_long?.split(/\s+/).length || 500;
const readTime = `${Math.ceil(wordCount / 200)} min read`;

// Format published date
const publishedDate = post.published_at || post.created_at;
const formattedDate = new Date(publishedDate).toLocaleDateString('en-US', {
  month: 'long',
  day: 'numeric',
  year: 'numeric'
});

// Structured data for SEO
const articleData = {
  headline: post.question,
  description: post.answer_short || '',
  datePublished: publishedDate,
  dateModified: post.updated_at || publishedDate,
  author: { '@type': 'Organization', name: siteConfig.name, url: siteUrl },
  publisher: {
    '@type': 'Organization',
    name: siteConfig.name,
    logo: { '@type': 'ImageObject', url: `${siteUrl}/images/PottyDirectory_Logo.png` }
  },
  mainEntityOfPage: { '@type': 'WebPage', '@id': `${siteUrl}/blog/post/${post.id}` }
};

// Get related posts (same category or recent)
let relatedPosts: ContentQuestion[] = [];
try {
  const allPosts = await getPublishedBlogs('potty');
  relatedPosts = allPosts
    .filter(p => p.id !== post.id)
    .slice(0, 3);
} catch (e) {
  console.error('Error fetching related posts:', e);
}

// Category colors
const categoryColors: Record<string, string> = {
  'Pricing': 'bg-green-100 text-green-700',
  'Events': 'bg-blue-100 text-blue-700',
  'Regulations': 'bg-red-100 text-red-700',
  'Planning': 'bg-purple-100 text-purple-700',
  'Weddings': 'bg-pink-100 text-pink-700',
  'Construction': 'bg-orange-100 text-orange-700',
  'General': 'bg-gray-100 text-gray-700',
  'Cost Pricing': 'bg-green-100 text-green-700',
  'How It Works': 'bg-blue-100 text-blue-700',
};
---

<BaseLayout title={post.question} description={post.answer_short || ''}>
  <StructuredData type="Article" data={articleData} />

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li><a href="/" class="hover:text-primary-600">Home</a></li>
        <li>/</li>
        <li><a href="/blog" class="hover:text-primary-600">Blog</a></li>
        <li>/</li>
        <li class="text-gray-900 truncate max-w-[200px]">{post.question}</li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-10">
      <span class={`inline-block text-sm font-semibold px-4 py-1.5 rounded-full mb-4 ${categoryColors[categoryDisplay] || 'bg-gray-100 text-gray-700'}`}>
        {categoryDisplay}
      </span>
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-6 leading-tight">
        {post.question}
      </h1>
      {post.answer_short && (
        <p class="text-xl text-gray-600 leading-relaxed">{post.answer_short}</p>
      )}
      <div class="mt-6 flex items-center text-sm text-gray-500">
        <span>{readTime}</span>
        <span class="mx-2">â€¢</span>
        <span>Published {formattedDate}</span>
      </div>
    </header>

    <!-- Content -->
    <div class="prose prose-lg max-w-none prose-headings:font-bold prose-a:text-primary-600 prose-a:no-underline hover:prose-a:underline">
      {post.answer_long ? (
        <Fragment set:html={post.answer_long} />
      ) : (
        <p>{post.answer_short}</p>
      )}
    </div>

    <!-- Ad Slot -->
    <div class="my-12">
      <AdSlot slot="content" />
    </div>

    <!-- CTA -->
    <div class="mt-12 bg-gradient-to-br from-primary-50 to-blue-50 rounded-2xl p-8 text-center border border-primary-100">
      <h3 class="text-2xl font-bold text-gray-900 mb-3">Ready to Get a Quote?</h3>
      <p class="text-gray-600 mb-6">Find trusted porta potty rental companies in your area</p>
      <a href="/" class="inline-flex items-center bg-primary-600 text-white px-8 py-4 rounded-xl font-semibold hover:bg-primary-700 transition-colors">
        Search Providers Near You
      </a>
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="mt-16">
        <h2 class="text-2xl font-bold text-gray-900 mb-8">Related Articles</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedPosts.map((related) => {
            const relatedCategory = related.category?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'General';
            return (
              <a href={`/blog/post/${related.id}`} class="bg-white rounded-xl p-6 border border-gray-200 hover:border-primary-300 hover:shadow-md transition-all">
                <span class={`text-xs font-semibold px-3 py-1 rounded-full ${categoryColors[relatedCategory] || 'bg-gray-100 text-gray-700'}`}>
                  {relatedCategory}
                </span>
                <h3 class="text-lg font-semibold text-gray-900 mt-3 line-clamp-2">{related.question}</h3>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </article>
</BaseLayout>
